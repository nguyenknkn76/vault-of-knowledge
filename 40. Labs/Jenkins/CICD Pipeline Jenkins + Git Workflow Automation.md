---
tags:
  - devops
  - cicd
  - jenkins
  - git
  - cicd/jenkins
  - cicd/git
---
## 00. Overview 

Required Resource

| No. | Resource | Name            | IP  | Note       |            |
| --- | -------- | --------------- | --- | ---------- | ---------- |
| 01  | EC2      | dop10-jk-master |     | `t3.micro` | `t3.small` |
|     |          | dop10-jk-agent  |     | `t3.micro` |            |
| 02  | ECR      |                 |     |            |            |

> [!warning] Jenkins Master Lack of Resources
> - Should use `t3.small` for EC2 Instance that run Jenkins Master
## 01. Setup Jenkins Master

Host Jenkins Master via Docker Compose> 
### Install Docker 

```bash 
sudo apt update 
sudo apt upgrade -y

sudo apt install apt-transport-https ca-certificates curl gnupg lsb-release -y

sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update
sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y

sudo systemctl status docker

sudo groupadd docker
sudo usermod -aG docker $USER
newgrp docker
docker ps
sudo systemctl restart docker
sudo chown root:docker /var/run/docker.sock

docker --version
docker compose version
```

### Deploy Jenkins via Docker Compose

```bash
mkdir jenkins-docker && cd jenkins-docker
mkdir jenkins_home agent_home
vi docker-compose.yml
```

```yml
# docker-compose.yml
services:
	jenkins-master:
		image: jenkins/jenkins:lts-jdk17
		container_name: jenkins-master
		restart: always
		ports:
			- "8080:8080"
			- "50000:50000"
		volumes:
			- ./jenkins_home:/var/jenkins_home
			- /var/run/docker.sock:/var/run/docker.sock # Permission for Jenkins to use Docker
		environment:
			- JAVA_OPTS=-Djenkins.install.runSetupWizard=true
			  
	jenkins-agent:
		image: jenkins/ssh-agent:jdk17
		container_name: jenkins-agent
		restart: always
		privileged: true
		environment:
		- JENKINS_AGENT_SSH_PUBKEY=your_public_key_here
		  
volumes:
	- ./agent_home:/home/jenkins/agent
	- /var/run/docker.sock:/var/run/docker.sock
```

```bash
docker compose up -d
docker compose logs # get init password
```

- Access url: `http://<ec2-instance-ip>:8080`
- Setup: 
	- Jenkins Account
	- Recommend plugins
	- Install Plugins: 
		- Pipeline Stage View
		- Nodejs

## 02. Setup Jenkins Agent 

Nodes > New Node: 
- Remote root directory: `/home/ubuntu/jenkins-agent`
- Labels: `self_hosted_agent`
- Launch method: `launch agent by connecting it to the controller`

```bash
# on ec2 instance: jenkins agent
mkdir jenkins-agent
cd jenkins-agent
pwd
# /home/ubuntu/jenkins-agent
```

Connect EC2 Instances as Jenkins Agent
```bash
# install java
sudo apt update
sudo apt install -y openjdk-17-jre-headless
java --version

# command be generated by jenkins master 
# on ec2 instance: jenkins agent 
curl -sO http://3.36.105.143:8080/jnlpJars/agent.jar
java -jar agent.jar -url http://3.36.105.143:8080/ -secret 13f2477b15cb180980123fas456f82c5d82ed8792327582664ed562e28988 -name "self_hosted_agent" -webSocket -workDir "/home/ubuntu/jenkins-agent"
```

## 03.  Config Trigger Jenkins Pipeline by GitHub Webhooks

### Jenkins Configuration

Open Pipelines > Build Trigger > enable `GitHub hook trigger for GITScm polling`
### GitHub Configuration

GitHub Repository > Settings > Webhooks > `Add WebHook`
- Payload: `http://<EC2_PUBLIC_IP>:8080/github-webhook/`
- Content Type: `application/json`
- Event: `Just the push event`

> [! note] EC2 Instances Settings
> - Inbound Rules / Security Group of Jenkins Master Instances have to open port `8080` for IP range of GitHub (or `0.0.0.0/0` for testing)

## 04. 



```groovy
pipeline {
    agent { label 'self_hosted_agent' }

    environment {
        DOCKER_HUB_USER = 'your_username'
        IMAGE_NAME      = 'your_repo_name'
        REGISTRY        = 'docker.io'
    }

    stages {
        stage('Initialize Docker') {
            steps {
                sh '''
                    # Install Docker CLI if not present
                    if ! command -v docker &> /dev/null; then
                        echo "Docker CLI not found. Installing..."
                        apt-get update && apt-get install -y docker.io
                    fi
                    docker --version
                '''
            }
        }

        stage('Clone Source') {
            steps {
                // Adjust this to your repository
                git branch: 'main', url: 'https://github.com/your-user/your-repo.git'
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building React App Image..."
                    // Builds using the Dockerfile in the root folder
                    sh "docker build -t ${DOCKER_HUB_USER}/${IMAGE_NAME}:${BUILD_NUMBER} ."
                    sh "docker tag ${DOCKER_HUB_USER}/${IMAGE_NAME}:${BUILD_NUMBER} ${DOCKER_HUB_USER}/${IMAGE_NAME}:latest"
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'DUSER', passwordVariable: 'DPASS')]) {
                    sh '''
                        echo $DPASS | docker login -u $DUSER --password-stdin
                        docker push ${DOCKER_HUB_USER}/${IMAGE_NAME}:${BUILD_NUMBER}
                        docker push ${DOCKER_HUB_USER}/${IMAGE_NAME}:latest
                    '''
                }
            }
        }
    }

    post {
        always {
            sh "docker logout"
            // Clean up local images to save EC2 space
            sh "docker rmi ${DOCKER_HUB_USER}/${IMAGE_NAME}:${BUILD_NUMBER} ${DOCKER_HUB_USER}/${IMAGE_NAME}:latest || true"
        }
    }
}
```
Config Git Credentials

Install dependencies

```bash
# install aws cli (install manually via cli)
# install docker (install manually via cli)
# install nodejs (using plugins + tools: NodeJS)
```


Create ECR repository
```bash
aws ecr create-repository \  
   --repository-name shopsquare/frontend
```


**Install AWS CLI**

```bash
sudo apt update && sudo apt install curl unzip -y


curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

aws --version
aws configure

# clean up: rm -rf awscliv2.zip ./aws
```

**Install Docker**

```bash
sudo apt update
sudo apt install ca-certificates curl gnupg -y

sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update

sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y

docker version
docker compose version
```


```bash
mkdir ~/.aws
touch ~/.aws/config ~/.aws/credentials
echo "[default]" > ~/.aws/credentials
echo "aws_access_key_id=${aws_access_key_id}" >> ~/.aws/credentials
echo "aws_secrest_access_key=${aws_secrest_access_key}" >> ~/.aws/credentials
echo "[default]" > ~/.aws/config
echo "region=${region}" >> ~/.aws/config
echo "output=json" >> ~/.aws/config

chmod 600 ~/.aws/config ~/.aws/credentials

aws s3 ls
```

Enable `GitHub hook trigger for GITScm polling`